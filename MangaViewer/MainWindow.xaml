<Window
    x:Class="MangaViewer.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:MangaViewer.ViewModels"
    xmlns:converters="using:MangaViewer.Converters"
    mc:Ignorable="d">

    <Grid x:Name="RootGrid">
        <Grid.Resources>
            <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <Grid x:Name="AppTitleBar" Grid.Row="0" Height="40" 
              Background="{ThemeResource LayerOnMicaBaseAltFillColorDefaultBrush}">
            <StackPanel Orientation="Horizontal" Spacing="10" Margin="10,0">
                <Button Command="{Binding TogglePaneCommand}" FontFamily="Segoe MDL2 Assets" Content="&#xE700;"/>
                <Button Content="폴더 열기" Click="OpenFolder_Click" IsEnabled="{Binding IsControlEnabled}"/>
                <Button Content="{Binding DirectionButtonText}" Command="{Binding ToggleDirectionCommand}"/>
                <Button Content="{Binding CoverButtonText}" Command="{Binding ToggleCoverCommand}"/>
                <Button Content="{Binding OcrButtonText}" Command="{Binding RunOcrCommand}" IsEnabled="{Binding IsControlEnabled}"/>
                <Button Content="OCR 지우기" Command="{Binding ClearOcrCommand}" 
                        Visibility="{Binding OcrResultsCount, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>
        </Grid>

        <!-- Main SplitView -->
        <SplitView Grid.Row="1"
                   PaneBackground="{ThemeResource ApplicationPageBackgroundThemeBrush}"
                   DisplayMode="Inline"
                   OpenPaneLength="160"
                   IsPaneOpen="{Binding IsPaneOpen, Mode=TwoWay}">
            <SplitView.Pane>
                <ListView ItemsSource="{Binding Thumbnails}"
                          SelectedIndex="{Binding SelectedThumbnailIndex, Mode=TwoWay}"
                          SelectionMode="Single">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:MangaPageViewModel">
                            <Image Source="{Binding ThumbnailSource, Mode=OneWay}" 
                                   Height="120" Stretch="Uniform" Margin="5"/>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </SplitView.Pane>

            <!-- Content -->
            <SplitView.Content>
                <Grid>
                    <!-- Single Page View -->
                    <Grid Visibility="{Binding IsSinglePageMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Image x:Name="SingleImage" Source="{Binding LeftImageSource}" Stretch="Uniform"
                                   SizeChanged="Image_SizeChanged"/>
                            <ItemsControl ItemsSource="{Binding LeftOcrResults}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Width="{Binding ElementName=SingleImage, Path=ActualWidth}"
                                                Height="{Binding ElementName=SingleImage, Path=ActualHeight}"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="viewmodels:BoundingBoxViewModel">
                                        <Grid Canvas.Left="{Binding X}"
                                              Canvas.Top="{Binding Y}"
                                              Width="{Binding Width}"
                                              Height="{Binding Height}"
                                              Background="Transparent">
                                            <Rectangle Fill="DodgerBlue" Opacity="0.22" Stroke="CornflowerBlue" StrokeThickness="1.0" />
                                            <Button Command="{Binding CopyCommand}" Opacity="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Grid>

                    <!-- Two Page View -->
                    <Grid Visibility="{Binding IsTwoPageMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Left Page -->
                        <Grid Grid.Column="0">
                            <Grid HorizontalAlignment="Right" VerticalAlignment="Center">
                                <Image x:Name="LeftImage" Source="{Binding LeftImageSource}" Stretch="Uniform"
                                       SizeChanged="Image_SizeChanged"/>
                                <ItemsControl ItemsSource="{Binding LeftOcrResults}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas Width="{Binding ElementName=LeftImage, Path=ActualWidth}"
                                                    Height="{Binding ElementName=LeftImage, Path=ActualHeight}"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:BoundingBoxViewModel">
                                            <Grid Canvas.Left="{Binding X}"
                                                  Canvas.Top="{Binding Y}"
                                                  Width="{Binding Width}"
                                                  Height="{Binding Height}"
                                                  Background="Transparent">
                                                <Rectangle Fill="DodgerBlue" Opacity="0.22" Stroke="CornflowerBlue" StrokeThickness="1.0" />
                                                <Button Command="{Binding CopyCommand}" Opacity="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>
                        </Grid>

                        <!-- Right Page -->
                        <Grid Grid.Column="1">
                            <Grid HorizontalAlignment="Left" VerticalAlignment="Center">
                                <Image x:Name="RightImage" Source="{Binding RightImageSource}" Stretch="Uniform"
                                       SizeChanged="Image_SizeChanged"/>
                                <ItemsControl ItemsSource="{Binding RightOcrResults}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas Width="{Binding ElementName=RightImage, Path=ActualWidth}"
                                                    Height="{Binding ElementName=RightImage, Path=ActualHeight}"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:BoundingBoxViewModel">
                                            <Grid Canvas.Left="{Binding X}"
                                                  Canvas.Top="{Binding Y}"
                                                  Width="{Binding Width}"
                                                  Height="{Binding Height}"
                                                  Background="Transparent">
                                                <Rectangle Fill="DodgerBlue" Opacity="0.22" Stroke="CornflowerBlue" StrokeThickness="1.0" />
                                                <Button Command="{Binding CopyCommand}" Opacity="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>
                        </Grid>
                    </Grid>
                </Grid>
            </SplitView.Content>
        </SplitView>

        <!-- Notification -->
        <Border Grid.Row="1"
                Visibility="{Binding IsNotificationVisible, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"
                VerticalAlignment="Bottom" HorizontalAlignment="Center" 
                Margin="20" Padding="10,5" 
                Background="#333333" CornerRadius="4" >
            <TextBlock Text="{Binding NotificationText}" Foreground="White"/>
        </Border>
    </Grid>
</Window>
